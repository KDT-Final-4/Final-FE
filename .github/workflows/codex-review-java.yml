name: Codex Code Review (TypeScript FE)

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  codex-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ github.token }}

    steps:
      # âœ… base ë¸Œëœì¹˜ë§Œ checkout (ì‹ ë¢°ëœ ì½”ë“œë§Œ ì‹¤í–‰)
      - name: Checkout base branch (safe)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Get list of changed files
        id: changed-files
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # âœ… í¬í¬ PR í¬í•¨, PR í—¤ë“œ ì»¤ë°‹ì„ ë³„ë„ ref(pr_head)ë¡œ fetch
          git fetch origin "pull/$PR_NUMBER/head:pr_head"

          git diff --name-only "$BASE_SHA" pr_head > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt || true

          FILES=$(paste -sd, changed_files.txt || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Validate OpenAI API Key
        env:
          API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          
          if [ -z "${API_KEY:-}" ]; then
            echo "âŒ FATAL ERROR: OPENAI_API_KEY is not set"
            echo "Please configure OPENAI_API_KEY in GitHub repository secrets"
            exit 1
          fi
          
          API_KEY_LENGTH=${#API_KEY}
          if [ "$API_KEY_LENGTH" -lt 20 ]; then
            echo "âš ï¸  WARNING: OPENAI_API_KEY seems too short (length: $API_KEY_LENGTH)"
            echo "Valid OpenAI API keys are typically 40+ characters"
            echo "Note: GitHub Actions masks secrets, actual length may be longer"
            echo "Proceeding with API call (actual validation will happen at API level)"
          else
            echo "âœ… OPENAI_API_KEY length check passed (length: $API_KEY_LENGTH characters)"
          fi
          
          # API í‚¤ í˜•ì‹ ê²€ì¦ (sk-ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸)
          if [[ "$API_KEY" != sk-* ]]; then
            echo "âš ï¸  WARNING: OPENAI_API_KEY does not start with 'sk-'"
            echo "This might indicate an invalid or old API key format"
            echo "Note: Actual validation will occur during API call"
          else
            echo "âœ… OPENAI_API_KEY format check passed (starts with 'sk-')"
          fi

      - name: Build Codex prompt from diff
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # ìœ„ì—ì„œ fetch í–ˆì–´ë„ í•œ ë²ˆ ë” ì‹œë„í•˜ëŠ” ê²ƒì€ ë¬¸ì œ ì—†ìŠµë‹ˆë‹¤.
          git fetch origin "pull/$PR_NUMBER/head:pr_head" || true

          # Diff í¬ê¸° ì²´í¬
          DIFF_LINES=$(git --no-pager diff --unified=5 "$BASE_SHA" pr_head | wc -l)
          echo "ğŸ“Š Diff size: $DIFF_LINES lines"
          
          if [ "$DIFF_LINES" -gt 5000 ]; then
            echo "âš ï¸  WARNING: Diff is very large ($DIFF_LINES lines)"
            echo "   Codex review might fail or be incomplete"
            echo "   Consider splitting this PR into smaller changes"
          fi

          cat > codex-prompt.md << 'EOF'
          ë‹¹ì‹ ì€ TypeScript ê¸°ë°˜ í”„ë¡ íŠ¸ì—”ë“œ(React, Vite, Radix UI)ë¥¼ ë‹´ë‹¹í•˜ëŠ” ì‹œë‹ˆì–´ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìì…ë‹ˆë‹¤.
          ì•„ë˜ Pull Requestì˜ ë³€ê²½ ì‚¬í•­ì— ëŒ€í•´ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•˜ì‹­ì‹œì˜¤.

          ìš”êµ¬ì‚¬í•­:
          - ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ, ì¡´ëŒ“ë§(ì‹­ì‹œì˜¤ì²´/í•©ë‹ˆë‹¤ì²´)ë¡œ ë‹µë³€í•˜ì‹­ì‹œì˜¤.
          - ë¦¬ë·° ê²°ê³¼ëŠ” JSON ë°°ì—´ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
          - ê° í•­ëª©ì€ ë‹¤ìŒ í•„ë“œë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
            - "file": "ë³€ê²½ëœ íŒŒì¼ì˜ ìƒëŒ€ ê²½ë¡œ"
            - "line": í•´ë‹¹ ì´ìŠˆë¥¼ ëŒ€í‘œí•˜ëŠ” ì½”ë“œì˜ 1-based line ë²ˆí˜¸
            - "severity": "Critical", "Major", "Minor" ì¤‘ í•˜ë‚˜
            - "title": ì´ìŠˆë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•œ í•œêµ­ì–´ ì œëª©
            - "body": ë¬¸ì œ ì„¤ëª…ê³¼ ê°œì„  ì œì•ˆì„ ë‹´ì€ í•œêµ­ì–´ ë³¸ë¬¸. ë°˜ë“œì‹œ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.

          ì‹¬ê°ë„ ê¸°ì¤€:
          - Critical: ëª¨ë¸ ë¡œì§ì´ ì˜ëª»ë˜ì–´ ê²°ê³¼ê°€ ì™„ì „íˆ í‹€ì–´ì§€ëŠ” ê²½ìš°, ì‹¬ê°í•œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜, ë¬´í•œ ë£¨í”„, ë³´ì•ˆ ì´ìŠˆ, NullPointerException ë“± ë°˜ë“œì‹œ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ì´ìŠˆ
          - Major: í•™ìŠµ/ì¶”ë¡  ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±ì´ í° ì½”ë“œ, ë°ì´í„° ì „ì²˜ë¦¬ ì˜¤ë¥˜, ì˜ëª»ëœ ì˜ˆì™¸ ì²˜ë¦¬, API ì˜¤ìš©, ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë“±
          - Minor: ì½”ë“œ ìŠ¤íƒ€ì¼, ë¦¬íŒ©í„°ë§ ì œì•ˆ, ë³€ìˆ˜ëª…/í•¨ìˆ˜ëª… ê°œì„  ë“±

          ì´ ì €ì¥ì†ŒëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì—­í• ì„ í•©ë‹ˆë‹¤:
          - TypeScript ê¸°ë°˜ React í”„ë¡ íŠ¸ì—”ë“œ
          - Vite ë²ˆë“¤ëŸ¬, Radix UI ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
          - Java ë°±ì—”ë“œ ë ˆí¬ì™€ë§Œ ìƒí˜¸ì‘ìš©

          ë¦¬ë·° ì‹œ íŠ¹íˆ ë‹¤ìŒì„ ì£¼ì˜ ê¹Šê²Œ ë´ ì£¼ì‹­ì‹œì˜¤:
          - ì»´í¬ë„ŒíŠ¸ì˜ ì±…ì„ ë¶„ë¦¬ê°€ ì ì ˆí•œì§€
          - ìƒíƒœ ê´€ë¦¬ê°€ ê³¼ë„í•˜ê²Œ ìƒìœ„ë¡œ í¼ì§€ì§€ ì•Šì•˜ëŠ”ì§€
          - ë¹„ë™ê¸° í†µì‹ (ë°±ì—”ë“œ í˜¸ì¶œ)ê³¼ ì—ëŸ¬ ì²˜ë¦¬ê°€ ì ì ˆí•œì§€
          - ì ‘ê·¼ì„±(ARIA ì†ì„±, í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ë“±)ì´ ì‹¬ê°í•˜ê²Œ ê¹¨ì§€ì§€ ì•Šì•˜ëŠ”ì§€
          - ë¶ˆí•„ìš”í•œ ì¬ë Œë”ë§, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜(useEffect ì˜ì¡´ì„± ë“±)ê°€ ì—†ëŠ”ì§€
          
          í•„ìš”í•˜ë‹¤ë©´ src/ ë””ë ‰í„°ë¦¬ ë‚´ë¶€ íŒŒì¼ì„ ìš°ì„ ì ìœ¼ë¡œ ë¦¬ë·°í•˜ê³ , ë¹Œë“œ ê²°ê³¼ë¬¼(dist ë“±)ì€ ë¬´ì‹œí•˜ì‹­ì‹œì˜¤.

          ì•„ë˜ì—ëŠ” ì´ë²ˆ Pull Requestì˜ diffê°€ í¬í•¨ë©ë‹ˆë‹¤.
          ì´ diffì—ì„œ ë³´ì´ëŠ” ë¶€ë¶„ì— ëŒ€í•´ì„œë§Œ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

          ìµœì¢… ì¶œë ¥ì€ ë°˜ë“œì‹œ ìœ„ì—ì„œ ì •ì˜í•œ JSON ë°°ì—´ í˜•ì‹ë§Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
          EOF

          echo "" >> codex-prompt.md
          echo "=== DIFF START ===" >> codex-prompt.md
          git --no-pager diff --unified=5 "$BASE_SHA" pr_head >> codex-prompt.md

      - name: Run Codex review
        id: run-codex
        uses: openai/codex-action@main
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          prompt-file: codex-prompt.md
          model: gpt-4o-mini
          output-file: codex-output.json
          sandbox: read-only
        continue-on-error: true

      - name: Check Codex review result
        continue-on-error: true
        run: |
          set -euo pipefail
          
          # ì´ì „ ìŠ¤í…ì˜ ê²°ê³¼ í™•ì¸
          if [ "${{ steps.run-codex.outcome }}" = "failure" ]; then
            echo "âŒ Codex review step failed"
            echo "Possible causes:"
            echo "  1. Invalid or expired OPENAI_API_KEY"
            echo "  2. API rate limit exceeded"
            echo "  3. Network connectivity issue"
            echo "  4. Invalid model name (currently using: gpt-4o-mini)"
            echo "  5. Diff size too large (> 5000 lines)"
            echo ""
            echo "Debug information:"
            echo "  - API Key status: ${{ env.OPENAI_API_KEY != '' && 'âœ… Set' || 'âŒ Not Set' }}"
            exit 1
          fi
          
          # ì¶œë ¥ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ ! -f codex-output.json ]; then
            echo "âŒ ERROR: codex-output.json file not created"
            echo "The Codex review action may have failed silently"
            exit 1
          fi
          
          # ì¶œë ¥ íŒŒì¼ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
          if [ ! -s codex-output.json ]; then
            echo "âš ï¸  WARNING: codex-output.json is empty"
            echo "Codex may have encountered an error or returned no comments"
            exit 1
          fi
          
          echo "âœ… Codex review completed successfully"
          echo "Output file size: $(wc -c < codex-output.json) bytes"

      - name: Parse Codex output into GitHub comments
        id: parse-codex
        run: |
          set -euo pipefail

          if [ ! -s codex-output.json ]; then
            echo "Codex output is empty. Nothing to comment."
            echo "has_comments=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Codex raw output:"
          cat codex-output.json
          echo ""

          # AI ì¶œë ¥ì—ì„œ JSON ë°°ì—´ë§Œ ì¶”ì¶œí•˜ëŠ” ì „ì²˜ë¦¬ í•¨ìˆ˜
          extract_json_array() {
            local input_file="$1"
            local output_file="$2"
            
            # ì„ì‹œ íŒŒì¼ì— ì›ë³¸ ì €ì¥
            cp "$input_file" "${input_file}.raw"
            
            # ë°©ë²• 1: ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ì˜ JSON ì¶”ì¶œ
            # ```json ... ``` ë˜ëŠ” ``` ... ``` íŒ¨í„´ ì°¾ê¸°
            if grep -q '```' "${input_file}.raw"; then
              # ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ ë‚´ìš©ë§Œ ì¶”ì¶œ
              sed -n '/```[a-z]*/,/```/p' "${input_file}.raw" | \
              sed 's/```[a-z]*//g' | \
              sed 's/```//g' | \
              sed '/^[[:space:]]*$/d' > "${output_file}.tmp" 2>/dev/null || true
              
              if [ -s "${output_file}.tmp" ]; then
                if jq . "${output_file}.tmp" > "${output_file}" 2>/dev/null; then
                  echo "Successfully extracted JSON from code block"
                  rm -f "${input_file}.raw" "${output_file}.tmp"
                  return 0
                fi
              fi
            fi
            
            # ë°©ë²• 2: ì²« ë²ˆì§¸ [ ë¶€í„° ë§ˆì§€ë§‰ ] ê¹Œì§€ ì¶”ì¶œ (ì¤‘ì²© êµ¬ì¡° ê³ ë ¤)
            # sedì™€ awkë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ë°°ì—´ ì¶”ì¶œ
            # ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° í›„ JSON ë°°ì—´ ì¶”ì¶œ
            sed -E 's/```[a-z]*//g; s/```//g' "${input_file}.raw" | \
            awk '
            BEGIN { in_array = 0; brace_count = 0; start_line = 0 }
            {
              for (i = 1; i <= length($0); i++) {
                char = substr($0, i, 1)
                if (char == "[") {
                  if (in_array == 0) {
                    in_array = 1
                    start_line = NR
                    brace_count = 1
                    printf "%s", char
                  } else {
                    brace_count++
                    printf "%s", char
                  }
                } else if (char == "]") {
                  if (in_array == 1) {
                    brace_count--
                    printf "%s", char
                    if (brace_count == 0) {
                      in_array = 0
                      exit
                    }
                  }
                } else if (in_array == 1) {
                  printf "%s", char
                }
              }
              if (in_array == 1) printf "\n"
            }
            ' > "${output_file}.tmp" 2>/dev/null || true
            
            if [ -s "${output_file}.tmp" ]; then
              if jq . "${output_file}.tmp" > "${output_file}" 2>/dev/null; then
                echo "Successfully extracted JSON array using awk"
                rm -f "${input_file}.raw" "${output_file}.tmp"
                return 0
              fi
            fi
            
            # ë°©ë²• 3: ì›ë³¸ì—ì„œ ì§ì ‘ JSON íŒŒì‹± ì‹œë„ (ì´ë¯¸ JSONì¸ ê²½ìš°)
            if jq 'try (fromjson) catch .' "$input_file" > "${output_file}" 2>/dev/null; then
              # ê²°ê³¼ê°€ ë°°ì—´ì¸ì§€ í™•ì¸
              if jq 'if type == "array" then . else empty end' "${output_file}" > "${output_file}.array" 2>/dev/null; then
                if [ -s "${output_file}.array" ]; then
                  mv "${output_file}.array" "${output_file}"
                  echo "Successfully parsed JSON array from raw output"
                  rm -f "${input_file}.raw" "${output_file}.tmp"
                  return 0
                fi
              fi
              rm -f "${output_file}.array"
            fi
            
            # ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
            echo "Failed to extract JSON array, returning empty array"
            echo "[]" > "${output_file}"
            rm -f "${input_file}.raw" "${output_file}.tmp"
            return 1
          }

          # JSON ë°°ì—´ ì¶”ì¶œ ì‹œë„
          if ! extract_json_array codex-output.json codex-output.json; then
            echo "Warning: Could not extract valid JSON array from Codex output"
            echo "has_comments=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # JSON ë°°ì—´ì´ ë¹„ì–´ìˆê±°ë‚˜ nullì¸ì§€ í™•ì¸
          ARRAY_LENGTH=$(jq 'if . == null then 0 else length end' codex-output.json 2>/dev/null || echo "0")
          
          if [ "$ARRAY_LENGTH" -eq 0 ] || [ "$ARRAY_LENGTH" = "null" ]; then
            echo "No review comments from Codex (empty or null array)."
            echo "has_comments=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Parsed Codex comments (array length: $ARRAY_LENGTH):"
          cat codex-output.json

          echo "has_comments=true" >> "$GITHUB_OUTPUT"

      - name: Post inline review comments to PR
        if: steps.parse-codex.outputs.has_comments == 'true'
        run: |
          set -euo pipefail

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          COMMIT_SHA=${{ github.event.pull_request.head.sha }}

          length=$(jq 'length' codex-output.json 2>/dev/null || echo "0")
          if [ "$length" -eq 0 ]; then
            echo "No comments to post."
            exit 0
          fi

          echo "Posting $length review comments from Codex..."
          SUCCESS_COUNT=0
          FAIL_COUNT=0

          for i in $(seq 0 $((length - 1))); do
            # í•„ìˆ˜ í•„ë“œ ì¶”ì¶œ (ì—ëŸ¬ ë°œìƒ ì‹œ ê±´ë„ˆë›°ê¸°)
            file=$(jq -r ".[$i].file // empty" codex-output.json 2>/dev/null || echo "")
            line=$(jq -r ".[$i].line // 1" codex-output.json 2>/dev/null || echo "1")
            severity=$(jq -r ".[$i].severity // \"Minor\"" codex-output.json 2>/dev/null || echo "Minor")
            title=$(jq -r ".[$i].title // \"ì½”ë“œ ë¦¬ë·°\"" codex-output.json 2>/dev/null || echo "ì½”ë“œ ë¦¬ë·°")
            body=$(jq -r ".[$i].body // \"\"" codex-output.json 2>/dev/null || echo "")

            # í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if [ -z "$file" ] || [ "$file" = "null" ]; then
              echo "Warning: Skipping comment $i (missing file field)"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              continue
            fi

            # lineì´ ìˆ«ìì¸ì§€ í™•ì¸
            if ! [[ "$line" =~ ^[0-9]+$ ]]; then
              echo "Warning: Invalid line number '$line' for $file, using line 1"
              line=1
            fi

            comment="[$severity] $title
            $body"

            echo "Comment on $file:$line"
            echo "$comment"
            echo "----"

            # comment.json ìƒì„± (ì—ëŸ¬ ì²˜ë¦¬)
            if ! jq -n \
              --arg body "$comment" \
              --arg path "$file" \
              --argjson line "$line" \
              --arg sha "$COMMIT_SHA" \
              '{
                  body: $body,
                  path: $path,
                  line: $line,
                  side: "RIGHT",
                  commit_id: $sha
                }' > comment.json 2>/dev/null; then
              echo "Error: Failed to create comment.json for $file:$line"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              continue
            fi

            # GitHub APIì— ì½”ë©˜íŠ¸ ì „ì†¡ (ì—ëŸ¬ ì²˜ë¦¬)
            HTTP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/curl_response.json \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/comments" \
              -d @comment.json || echo "000")

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "Successfully posted comment for $file:$line"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "Error: Failed to post comment for $file:$line (HTTP $HTTP_CODE)"
              cat /tmp/curl_response.json 2>/dev/null || true
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done

          echo "Comment posting summary: $SUCCESS_COUNT succeeded, $FAIL_COUNT failed"
          if [ "$FAIL_COUNT" -gt 0 ] && [ "$SUCCESS_COUNT" -eq 0 ]; then
            echo "All comments failed to post. Exiting with error."
            exit 1
          fi

      - name: Post summary comment
        if: steps.parse-codex.outputs.has_comments == 'true'
        run: |
          set -euo pipefail

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          SUMMARY="**Codex ìë™ ì½”ë“œ ë¦¬ë·° ìš”ì•½**

          Codexê°€ PRì— ëŒ€í•œ ìë™ ì½”ë“œ ë¦¬ë·°ë¥¼ ìƒì„±í•˜ì˜€ìŠµë‹ˆë‹¤.
          ì„¸ë¶€ ë‚´ìš©ì€ inline ì½”ë©˜íŠ¸ë¥¼ ì°¸ê³ í•´ ì£¼ì‹­ì‹œì˜¤."

          # summary.json ìƒì„± (ì—ëŸ¬ ì²˜ë¦¬)
          if ! jq -n --arg body "$SUMMARY" '{ body: $body }' > summary.json 2>/dev/null; then
            echo "Error: Failed to create summary.json"
            exit 1
          fi

          # GitHub APIì— ìš”ì•½ ì½”ë©˜íŠ¸ ì „ì†¡ (ì—ëŸ¬ ì²˜ë¦¬)
          HTTP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/summary_response.json \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d @summary.json || echo "000")

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully posted summary comment"
          else
            echo "Warning: Failed to post summary comment (HTTP $HTTP_CODE)"
            cat /tmp/summary_response.json 2>/dev/null || true
            # ìš”ì•½ ì½”ë©˜íŠ¸ ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë¯€ë¡œ exit 0
            exit 0
          fi

      - name: Post error comment if Codex review failed
        if: failure() && steps.run-codex.outcome == 'failure'
        run: |
          set -euo pipefail
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          
          ERROR_MESSAGE="âŒ **Codex ìë™ ì½”ë“œ ë¦¬ë·° ì‹¤íŒ¨**

          Codex ë¦¬ë·° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

          **ê°€ëŠ¥í•œ ì›ì¸:**
          1. **API í‚¤ ë¬¸ì œ**: OPENAI_API_KEYê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë¨
          2. **API í˜¸ì¶œ ì‹¤íŒ¨**: OpenAI API ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ
          3. **ëª¨ë¸ ì˜¤ë¥˜**: gpt-4o-mini ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ
          4. **Diff í¬ê¸°**: ë³€ê²½ ì‚¬í•­ì´ ë„ˆë¬´ ë§ìŒ (5000ì¤„ ì´ìƒ)
          5. **Rate limit**: API í˜¸ì¶œ í•œë„ ì´ˆê³¼

          **í•´ê²° ë°©ë²•:**
          - ë¦¬í¬ì§€í† ë¦¬ ì„¤ì •ì—ì„œ OPENAI_API_KEYê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
          - API í‚¤ê°€ ìœ íš¨í•œì§€ OpenAI ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”
          - ë³€ê²½ ì‚¬í•­ì´ ë§ìœ¼ë©´ PRì„ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì„¸ìš”
          - ë¦¬í¬ì§€í† ë¦¬ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”

          **ì›Œí¬í”Œë¡œìš° ë¡œê·¸:** https://github.com/$REPO/actions/runs/${{ github.run_id }}"
          
          # error-comment.json ìƒì„±
          jq -n --arg body "$ERROR_MESSAGE" '{ body: $body }' > error-comment.json
          
          # GitHub APIì— ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡
          HTTP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/error_response.json \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d @error-comment.json || echo "000")
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Successfully posted error comment to PR"
          else
            echo "âš ï¸  Warning: Failed to post error comment (HTTP $HTTP_CODE)"
            cat /tmp/error_response.json 2>/dev/null || true
          fi