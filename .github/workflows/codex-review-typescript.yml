name: Codex Code Review (TypeScript FE)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  codex-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout pull request merge commit
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Build Codex prompt from diff (TypeScript frontend)
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          cat > codex-prompt.md << 'EOF'
          당신은 TypeScript 기반 프론트엔드(React, Vite, Radix UI)를 담당하는 시니어 프론트엔드 개발자입니다.
          아래 Pull Request의 변경 사항에 대해 코드 리뷰를 수행하십시오.

          요구사항:
          - 반드시 한국어로, 존댓말(하십시오체)로 답변하십시오.
          - 리뷰 결과는 JSON 배열로만 작성하십시오. 다른 텍스트는 포함하지 마십시오.
          - 각 항목은 다음 필드를 포함해야 합니다:
            - "file": "변경된 파일의 상대 경로"
            - "line": 해당 이슈를 대표하는 코드의 1-based line 번호
            - "severity": "Critical", "Major", "Minor" 중 하나
            - "title": 이슈를 한 문장으로 요약한 한국어 제목
            - "body": 문제 설명과 개선 제안을 담은 한국어 본문. 반드시 존댓말(하십시오체)을 사용하십시오.

          심각도 기준:
          - Critical: 런타임 에러, 빌드 실패를 유발하는 문제, 보안 이슈(XSS 등), UX를 심각하게 망가뜨리는 버그
          - Major: 상태 관리/렌더링 로직이 복잡해 유지보수가 어렵거나, 성능 저하를 유발할 수 있는 구조 등
          - Minor: 코드 스타일, 컴포넌트 분리 제안, 접근성 개선, 네이밍 개선 등

          이 저장소는 다음과 같은 역할을 합니다:
          - TypeScript 기반 React 프론트엔드
          - Vite 번들러, Radix UI 컴포넌트 사용
          - Java 백엔드 레포와만 상호작용

          리뷰 시 특히 다음을 주의 깊게 봐 주십시오:
          - 컴포넌트의 책임 분리가 적절한지
          - 상태 관리가 과도하게 상위로 퍼지지 않았는지
          - 비동기 통신(백엔드 호출)과 에러 처리가 적절한지
          - 접근성(ARIA 속성, 키보드 네비게이션 등)이 심각하게 깨지지 않았는지
          - 불필요한 재렌더링, 메모리 누수(useEffect 의존성 등)가 없는지

          필요하다면 src/ 디렉터리 내부 파일을 우선적으로 리뷰하고, 빌드 결과물(dist 등)은 무시하십시오.

          아래에는 이번 Pull Request의 diff가 포함됩니다.
          이 diff에서 보이는 부분에 대해서만 리뷰를 작성하십시오.

          최종 출력은 반드시 위에서 정의한 JSON 배열 형식만 사용하십시오.
          EOF

          echo "" >> codex-prompt.md
          echo "=== DIFF START ===" >> codex-prompt.md
          git --no-pager diff --unified=5 "$BASE_SHA" "$HEAD_SHA" >> codex-prompt.md

      - name: Run Codex review
        id: run-codex
        uses: openai/codex-action@main
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          prompt-file: codex-prompt.md
          model: o4-mini
          output-file: codex-output.json
          sandbox: read-only

      - name: Parse Codex output into GitHub comments
        id: parse-codex
        run: |
          set -euo pipefail

          if [ ! -s codex-output.json ]; then
            echo "Codex output is empty. Nothing to comment."
            echo "has_comments=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Codex raw output:"
          cat codex-output.json
          echo ""

          NORMALIZED=$(cat codex-output.json | jq 'try (fromjson) catch .')
          echo "$NORMALIZED" > codex-output.json

          if [ "$(jq 'length' codex-output.json)" -eq 0 ]; then
            echo "No review comments from Codex."
            echo "has_comments=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Parsed Codex comments:"
          cat codex-output.json

          echo "has_comments=true" >> "$GITHUB_OUTPUT"

      - name: Post inline review comments to PR
        if: steps.parse-codex.outputs.has_comments == 'true'
        run: |
          set -euo pipefail

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          COMMIT_SHA=${{ github.event.pull_request.head.sha }}

          length=$(jq 'length' codex-output.json)
          echo "Posting $length review comments from Codex..."

          for i in $(seq 0 $((length - 1))); do
            file=$(jq -r ".[$i].file" codex-output.json)

            # dist/나 빌드 산출물은 건너뜁니다.
            if [[ "$file" == dist/* ]] || [[ "$file" == build/* ]]; then
              echo "Skip comment for $file (build artifact)"
              continue
            fi

            line=$(jq -r ".[$i].line" codex-output.json)
            severity=$(jq -r ".[$i].severity" codex-output.json)
            title=$(jq -r ".[$i].title" codex-output.json)
            body=$(jq -r ".[$i].body" codex-output.json)

            comment="[$severity] $title
            $body"

            echo "Comment on $file:$line"
            echo "$comment"
            echo "----"

            jq -n               --arg body "$comment"               --arg path "$file"               --argjson line "$line"               --arg sha "$COMMIT_SHA"               '{
                body: $body,
                path: $path,
                line: $line,
                side: "RIGHT",
                commit_id: $sha
              }' > comment.json

            curl -sS               -X POST               -H "Accept: application/vnd.github+json"               -H "Authorization: Bearer '"'"'${GITHUB_TOKEN}'"'"'               -H "X-GitHub-Api-Version: 2022-11-28"               "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/comments"               -d @comment.json

      - name: Post summary comment
        if: steps.parse-codex.outputs.has_comments == 'true'
        run: |
          set -euo pipefail

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          SUMMARY="**Codex 자동 코드 리뷰 요약**

          Codex가 PR에 대한 자동 코드 리뷰를 생성하였습니다.
          세부 내용은 inline 코멘트를 참고해 주십시오."

          jq -n --arg body "$SUMMARY" '{ body: $body }' > summary.json

          curl -sS             -X POST             -H "Accept: application/vnd.github+json"             -H "Authorization: Bearer '"'"'${GITHUB_TOKEN}'"'"'             -H "X-GitHub-Api-Version: 2022-11-28"             "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"             -d @summary.json
